<!doctype html>
<html ng-app="PerfApp">
<head>
  <meta charset="utf-8">
  <title>Employee Performance System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body ng-controller="MainCtrl as vm">
<nav class="navbar navbar-expand-lg navbar-dark sticky-top shadow-sm navbar-gradient py-2">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center fw-bold text-white" href="#">
      <!-- <img src="images/logo.png" alt="Logo" width="48" height="48" class="me-2 rounded-2"> -->
      <span>ZeEPM</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0 gap-1">
        <li class="nav-item" ng-if="vm.token">
          <a class="nav-link" ng-class="{ 'active': vm.view==='about' }" href="" ng-click="vm.view='about'"><i class="bi bi-journal-text me-1"></i> About</a>
        </li>
        <li class="nav-item" ng-if="vm.token">
          <a class="nav-link" ng-class="{ 'active': vm.view==='dashboard' }" href="" ng-click="vm.view='dashboard'"><i class="bi bi-bar-chart-line me-1"></i> Dashboard</a>
        </li>
      </ul>
      <div class="d-flex ms-lg-3">
        <span ng-if="!vm.token"><button class="btn btn-nav-outline me-2" ng-click="vm.view='login'"><i class="bi bi-box-arrow-in-right me-1"></i> Login</button></span>
        <span ng-if="vm.token" class="me-2">
          <button class="btn btn-nav-outline" data-bs-toggle="modal" data-bs-target="#resetPwdModal">
            <i class="bi bi-shield-lock me-1"></i> Reset Password
          </button>
        </span>
        <span ng-if="vm.token"><button class="btn btn-nav-primary" ng-click="vm.logout()"><i class="bi bi-box-arrow-right me-1"></i> Logout</button></span>
      </div>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div ng-switch="vm.view">

    <div ng-switch-when="about" class="container mt-4">
      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body">
          <h3 class="card-title mb-3">About ZeEPM</h3>
          <p>
            The <strong>Employee Performance Management System (ZeEPM)</strong> evaluates
            employee performance using a weighted scoring model. Each metric is assigned a
            percentage weight, and the final performance score is the sum of all weighted metrics.
          </p>

          <h5 class="mt-4">Performance Metrics & Weights</h5>
          <table class="table table-hover table-bordered mt-2">
            <thead class="table-light">
              <tr>
                <th>Metric</th>
                <th>Weight</th>
                <th>Measurement</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Quality of Work</td>
                <td>20%</td>
                <td>Timeliness, minimal errors, standards, innovation</td>
              </tr>
              <tr>
                <td>Dependability / Reliability</td>
                <td>10%</td>
                <td>Consistency, minimal supervision, assurance</td>
              </tr>
              <tr>
                <td>Initiative</td>
                <td>10%</td>
                <td>Motivation, research, proactive improvement</td>
              </tr>
              <tr>
                <td>Adaptability</td>
                <td>10%</td>
                <td>Flexibility, new tech learning, ambiguous tasks</td>
              </tr>
              <tr>
                <td>Compliance with Policies</td>
                <td>10%</td>
                <td>Code of conduct, confidentiality, attendance</td>
              </tr>
              <tr>
                <td>Interpersonal Relations</td>
                <td>10%</td>
                <td>Teamwork, positivity, client interactions</td>
              </tr>
              <tr>
                <td>Time Management</td>
                <td>10%</td>
                <td>Productivity, multitasking</td>
              </tr>
              <tr>
                <td>Communication Skills</td>
                <td>10%</td>
                <td>Clarity, professionalism, client-friendly</td>
              </tr>
              <tr>
                <td>Self-Improvement / Learning</td>
                <td>10%</td>
                <td>Continuous learning & skill development</td>
              </tr>
            </tbody>
          </table>

          <h5 class="mt-4">How Final Score is Calculated</h5>
          <p>
            Each metric score is multiplied by its weight, then summed to produce a
            <strong>Final Performance Score</strong> (0â€“4).
          </p>

          <div class="alert alert-info mt-3">
            <strong>Formula:</strong>  
            Final Score = Î£ (Metric Score Ã— Weight %)
          </div>

          <p class="mt-3">
            Example: If an employee scores 3/4 in Quality of Work, contribution =
            <code>3 Ã— 0.20 = 0.6</code>. The same is applied to all metrics, and the total
            is the employeeâ€™s performance score.
          </p>
        </div>
      </div>
    </div>


    <div ng-switch-when="login" class="d-flex justify-content-center align-items-center" style="min-height:70vh;">
      <div class="card shadow-sm p-4" style="max-width: 360px; width:100%; border-radius: 1rem;">
        <h4 class="text-center mb-3">ðŸ”‘ Login</h4>
        <form ng-submit="vm.login()">
          <div class="form-floating mb-3">
            <input type="email" class="form-control" id="loginEmail" placeholder="name@example.com" ng-model="vm.loginForm.email" required>
            <label for="loginEmail">Email</label>
          </div>
          <div class="form-floating mb-3">
            <input type="password" class="form-control" id="loginPassword" placeholder="Password" ng-model="vm.loginForm.password" required>
            <label for="loginPassword">Password</label>
          </div>
          <button class="btn btn-primary w-100 rounded-3">Login</button>
          <div class="mt-3 text-danger small text-center" ng-if="vm.loginError">{{vm.loginError}}</div>
        </form>
      </div>
    </div>

    <div ng-switch-when="dashboard">
      <!-- Logged-in User Summary Card -->
      <div class="container py-4" ng-if="vm.dashboard">
        <div class="row justify-content-center">
          <div class="col-lg-12">
            <div class="card border-0 shadow-sm rounded-4 mb-4">
              <div class="card-body d-flex align-items-center gap-3 flex-wrap">
                <div class="avatar-circle" ng-class="'avatar-color-' + (vm.getAvatarColor((vm.dashboard.employee && vm.dashboard.employee.name) || vm.dashboard.email))">
                  <i class="bi bi-person-fill fs-1 text-white"></i>
                </div>

                <div class="flex-grow-1">
                  <h4 class="mb-1">{{ (vm.dashboard.employee && vm.dashboard.employee.name) }}</h4>
                  <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span ng-if="vm.dashboard.employee && vm.dashboard.employee.designation" class="badge bg-secondary">{{ vm.dashboard.employee.designation }}</span>
                  </div>
                  <span class="text-secondary">{{ vm.dashboard.email }}</span>
                </div>
              </div>
              <div class="container py-4">

                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                  <div class="d-flex align-items-center gap-2">
                    <span class="badge rounded-pill bg-light text-secondary border"><h5 class="fw-bold text-secondary mb-0">My Reportees: {{ vm.dashboard.reportees_count }}</h5></span>
                  </div>
                  <div class="search-group input-group shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-secondary"></i></span>
                    <input type="text" class="form-control border-start-0" 
                           placeholder="Search employee by name, email, or designation"
                           aria-label="Search employee"
                           ng-model="vm.searchText">
                    <button type="button" class="btn btn-outline-secondary btn-clear" 
                            ng-if="vm.searchText"
                            aria-label="Clear search"
                            ng-click="vm.searchText=''">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                </div>
          
                <!-- Employee Grid -->
                <div class="row g-4">
                  <div class="col-md-6 col-lg-4" 
                       ng-repeat="e in vm.employees | filter:vm.searchText">
          
                    <div class="card border-0 shadow-lg rounded-4 h-100 hover-card">
                      <div class="card-body text-center d-flex flex-column">
          
                        <!-- Avatar -->
                        <div class="avatar-circle mx-auto mb-3" 
                             ng-class="'avatar-color-' + (vm.getAvatarColor(e.name))">
                          <i class="bi bi-person-fill fs-1 text-white"></i>
                        </div>
          
                        <!-- Employee Info -->
                        <h5 class="fw-bold mb-1">{{e.name}}</h5>
                        <span class="badge bg-info text-white px-3 py-2 mb-2">
                          {{e.designation}}
                        </span>
                        <p class="text-muted small mb-2">
                          <i class="bi bi-envelope me-1"></i>{{e.email}}
                        </p>
          
                        <!-- Actions -->
                        <div class="d-flex justify-content-center mt-auto gap-2">
                          <button class="btn btn-sm btn-soft-primary rounded-3 px-2 shadow-sm" 
                                  aria-label="View performance report"
                                  ng-click="vm.viewEmployee(e, 'report')">
                            <i class="bi bi-graph-up-arrow me-1"></i> View Report
                          </button>
                          <button class="btn btn-sm btn-soft-secondary rounded-3 px-2 shadow-sm" 
                                  aria-label="Add performance review"
                                  ng-click="vm.addReview(e)">
                            <i class="bi bi-clipboard-plus me-1"></i> Add Review
                          </button>
                         </div>
                      </div>
                    </div>
          
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

      <!-- Admin Team Ranking (only for admin) -->
      <div ng-if="vm.role==='admin'" class="my-4">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <h5 class="mb-0">ðŸ‘¥ Team Ranking</h5>
            <button class="btn btn-sm btn-outline-primary" ng-click="vm.fetchTeam()">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
          <div class="card-body p-3" ng-if="vm.team.length">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Employee</th>
                    <th scope="col">Final Score</th>
                  </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="t in vm.team track by $index">
                    <td>{{$index + 1}}</td>
                    <td>{{t.name}}</td>
                    <td><span class="badge bg-success">{{t.final_score | number:2}}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-body text-muted text-center" ng-if="!vm.team.length">
            <em>No team data available</em>
          </div>
        </div>
      </div>

      <div ng-if="vm.view==='report'">
        <div class="row mb-4">
          <!-- Subordinate Dropdown -->
          <div class="col-md-6">
            <h6 class="fw-bold">My Reportee</h6>
            <select class="form-select" ng-model="vm.selectedEmp" 
                    ng-change="vm.selectedMonth=''; vm.loadAvailableMonths(vm.selectedEmp)">
              <option ng-repeat="e in vm.employees" ng-value="e.id">{{e.name}}</option>
            </select>
          </div>

          <!-- Month Dropdown -->
          <div class="col-md-6">
            <h6 class="fw-bold">Select Month</h6>
            <select class="form-select" ng-model="vm.selectedMonth"
                    ng-options="month as month for month in vm.availableMonths"
                    ng-change="vm.loadMetrics(vm.selectedEmp, vm.selectedMonth)">
            </select>
          </div>
        </div>
          <!-- Final Score Card -->
          <div class="card border-0 shadow-sm rounded-3 mb-3" ng-if="vm.finalScore !== undefined">
            <div class="card-body d-flex flex-wrap align-items-center justify-content-between">
              <div class="text-end">
                <div class="text-muted small">Rating for a Month (0â€“4)</div>
                <div class="h3 fw-bold">{{ vm.finalScore | number:2 }} / 4</div>
              </div>
              <div class="text-end mt-3 mt-sm-0" ng-if="vm.overallFinalScore !== undefined">
                <div class="text-muted small">Overall Final Rating (All Months, 0â€“4)</div>
                <div class="h3 fw-bold mb-0">{{ vm.overallFinalScore | number:2 }} / 4</div>
              </div>
            </div>
          </div>

          <div class="mt-4" ng-if="vm.chartData">
            <div class="card border-0 shadow-lg rounded-3">
              <!-- Chart Header -->
              <div class="card-header bg-gradient bg-info text-white d-flex align-items-center">
                <i class="bi bi-graph-up me-2"></i>
                <h5 class="mb-0">Performance Metrics Overview</h5>
              </div>

              <!-- Chart Body -->
              <div class="card-body">
                <div class="chart-container" style="position: relative; height:400px; width:100%">
                  <canvas id="metricChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          </div>
          <div ng-switch-when="addreview">
            <div class="mt-4">
              <div class="card border-0 shadow-lg rounded-3 metrics-card">
                <!-- Header -->
                <div class="card-header bg-gradient bg-info text-white d-flex align-items-center">
                  <i class="bi bi-clipboard-check me-2"></i>
                  <h5 class="mb-0">Add Employee Performance Metrics</h5>
                </div>

                <!-- Body -->
                <div class="card-body bg-light">
                  <form ng-submit="vm.addAllMetrics(vm.selectedEmp)">
                    <div class="table-responsive metrics-table-wrapper">
                      <table class="table table-sm table-hover align-middle mb-0 metrics-table">
                        <thead class="table-primary">
                          <tr>
                            <th style="width:20%">Metric</th>
                            <th style="width:10%" class="text-center">Score (0â€“4)</th>
                            <th style="width:70%">Comments</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr ng-repeat="metric in vm.metricsList" class="align-middle">
                            <!-- Metric Label -->
                            <td class="fw-semibold">{{metric.label}}</td>

                            <!-- Score -->
                            <td>
                              <input type="number"
                                    class="form-control form-control-sm text-center score-input"
                                    ng-model="metric.score" min="0" max="4"
                                    placeholder="0-4" required>
                            </td>

                            <!-- Comment -->
                            <td>
                              <textarea class="form-control form-control-sm metric-comment"
                                        style="min-width: 100%;"
                                        rows="2"
                                        ng-model="metric.comment"
                                        placeholder="Add detailed notes..."></textarea>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <!-- Save Button -->
                    <div class="mt-3 text-end">
                      <button class="btn btn-success btn-lg px-2 shadow-sm">
                        <i class="bi bi-save me-1"></i> Save Metrics
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
    </div>
  </div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPwdModal" tabindex="-1" aria-labelledby="resetPwdModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="resetPwdModalLabel">Reset Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form ng-submit="vm.resetPassword()">
          <div class="mb-3">
            <label for="currentPassword" class="form-label">Current Password</label>
            <input type="password" class="form-control" id="currentPassword" ng-model="vm.pwd.current" required>
          </div>
          <div class="mb-3">
            <label for="newPassword" class="form-label">New Password</label>
            <input type="password" class="form-control" id="newPassword" ng-model="vm.pwd.new" required>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Confirm New Password</label>
            <input type="password" class="form-control" id="confirmPassword" ng-model="vm.pwd.confirm" required>
          </div>
          <div class="text-danger small mb-2" ng-if="vm.pwdError">{{vm.pwdError}}</div>
          <div class="text-success small mb-2" ng-if="vm.pwdMsg">{{vm.pwdMsg}}</div>
          <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary"><i class="bi bi-shield-check me-1"></i> Update Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="app.js"></script>
</body>
</html>
